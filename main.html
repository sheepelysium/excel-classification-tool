<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工程圖樣自動分類器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            transform: translateY(-2px);
        }
        
        .upload-area.dragover {
            border-color: #764ba2;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .results {
            margin-top: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .sample-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .sample-table th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }
        
        .sample-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }
        
        .sample-table th:nth-child(1), .sample-table td:nth-child(1) { width: 15%; } /* B欄位 */
        .sample-table th:nth-child(2), .sample-table td:nth-child(2) { width: 60%; } /* C欄位 */
        .sample-table th:nth-child(3), .sample-table td:nth-child(3) { width: 8%; }  /* D欄位 */
        .sample-table th:nth-child(4), .sample-table td:nth-child(4) { width: 17%; } /* E欄位 */
        
        .sample-table tr:hover {
            background: #f8f9fa;
        }
        
        .category-tag {
            display: inline-block;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            margin: 2px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .log-area {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            height: 200px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        .tab-container {
            margin: 20px 0;
        }
        
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #667eea;
            margin-bottom: 20px;
        }
        
        .tab-button {
            background: transparent;
            border: none;
            padding: 15px 30px;
            cursor: pointer;
            font-size: 16px;
            color: #667eea;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px 10px 0 0;
        }
        
        .tab-button:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .category-detail {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #667eea;
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .category-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .category-count {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .category-keywords {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }
        
        .unclassified-list {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border-radius: 5px;
            padding: 15px;
        }
        
        .unclassified-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }
        
        .hidden {
            display: none;
        }
        
        .download-section {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
        }
        
        .download-section {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏗️ 工程圖樣智能分類器</h1>
        
        <div class="upload-area" id="uploadArea">
            <h3>📁 上傳Excel檔案</h3>
            <p>拖拽檔案到這裡，或點擊選擇檔案</p>
            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;">
            <button class="btn" onclick="document.getElementById('fileInput').click()">選擇檔案</button>
        </div>
        
        <div class="progress-bar hidden" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="log-area hidden" id="logArea"></div>
        
        <div class="results hidden" id="results">
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="showTab('overview')">📊 總覽統計</button>
                    <button class="tab-button" onclick="showTab('categories')">🏷️ 分類詳情</button>
                    <button class="tab-button" onclick="showTab('unclassified')">❓ 未分類項目</button>
                    <button class="tab-button" onclick="showTab('samples')">📋 資料預覽</button>
                </div>
                
                <div id="tab-overview" class="tab-content active">
                    <h2>📊 分類統計總覽</h2>
                    <div class="stats-grid" id="statsGrid"></div>
                </div>
                
                <div id="tab-categories" class="tab-content">
                    <h2>🏷️ 詳細分類統計</h2>
                    <div id="categoryDetails"></div>
                </div>
                
                <div id="tab-unclassified" class="tab-content">
                    <h2>❓ 未分類項目詳情</h2>
                    <div id="unclassifiedDetails"></div>
                </div>
                
                <div id="tab-samples" class="tab-content">
                    <h2>📋 分類樣本預覽</h2>
                    <table class="sample-table" id="sampleTable">
                        <thead>
                            <tr>
                                <th>工程名稱</th>
                                <th>圖樣內容</th>
                                <th>圖號</th>
                                <th>分類結果</th>
                            </tr>
                        </thead>
                        <tbody id="sampleTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="download-section">
                <h3>💾 下載分類結果</h3>
                <button class="btn" id="downloadBtn">下載Excel檔案</button>
                <button class="btn" id="downloadCsvBtn">下載CSV檔案</button>
            </div>
        </div>
    </div>

    <script>
        // 分類規則 - 保留原有32類 + 整合AI建議新增
        const classificationRules = {
            // === 原有圖面類型（保留+微調） ===
            "平面圖": ["平面圖", "配置圖", "位置圖", "佈置圖", "layout", "平面", "平縱面圖", "平面及縱面圖", "平面及縱坡圖"],
            "標準斷面": ["斷面圖", "剖面圖", "橫斷面", "標準斷面", "section", "橫段面", "橫断面"], // 保留原有+新增橫斷面變體
            "縱面圖": ["縱面圖", "縱坡圖", "縱斷面圖", "profile"], // 【新增】從標準斷面分離出來
            "立面圖": ["立面圖", "正面圖", "側面圖", "elevation"],
            "詳圖": ["詳圖", "大樣圖", "節點圖", "構造詳圖", "detail", "祥圖"], // 新增"祥圖"
            "竣工圖": ["竣工圖", "完工圖", "as-built"],
            "施工圖": ["施工圖", "施工說明", "construction"],
            "示意圖": ["示意圖", "展開圖", "控制圖", "指示圖", "示意", "佈設圖"], // 新增變體
            "設計圖": ["設計圖", "細部設計", "零件圖", "零件", "組立圖"], // 【新增】AI建議
            
            // === 原有結構工程（保留+細分） ===
            "橋樑工程": ["橋", "橋台", "橋墩", "橋面", "橋梁", "bridge"],
            "上部結構": ["上部結構", "樑", "梁", "拱度", "預力", "箱型梁", "鋼梁", "P.C.", "崗支樑", "懸臂梁"], // 【新增】AI建議
            "隧道工程": ["隧道", "涵洞", "通道", "tunnel", "洞口", "管幕"], // 新增"管幕"
            "擋土工程": ["擋土牆", "護坡", "邊坡", "擋土", "retaining", "保護工", "護岸", "固床工"], // 新增變體
            
            // === 原有道路工程（保留+新增） ===
            "道路工程": ["路面", "車道", "路基", "路肩", "人行道", "道路", "路線", "快速公路", "拓寬"], // 新增變體
            "路線設計": ["曲線", "超高", "線形", "匝道", "交流道", "聯絡道", "農路", "引道", "槽化"], // 【新增】AI建議
            "交通設施": ["標誌", "標線", "號誌", "護欄", "欄杆", "交通", "安全設施", "倒數燈", "導標", "里程牌"], // 新增變體
            "排水工程": ["排水", "下水道", "雨水", "集水", "溝渠", "drainage", "溝蓋", "水溝", "邊溝", "暗溝", "明溝", "U溝", "箱涵", "滯洪", "沉砂池"], // 新增大量變體
            
            // === 原有材料結構（保留） ===
            "鋼筋": ["鋼筋", "配筋", "鋼筋圖", "reinforcement", "鋼筋配置", "補強筋"],
            "地質鑽探": ["地質", "鑽探", "地質調查", "鑽孔", "土壤", "地盤"],
            "基礎型式": ["基礎", "樁基", "基樁", "基礎版", "foundation", "基腳", "承台", "樁位", "地錨", "基座", "開挖"],
            "混凝土結構": ["混凝土", "預力", "預鑄", "concrete", "RC"],
            "支承系統": ["支承", "伸縮縫", "止震", "bearing", "支承墊"],
            
            // === 原有環境景觀（保留） ===
            "景觀工程": ["植栽", "綠化", "景觀", "綠石", "landscape", "美化", "植生"],
            "環境保護": ["環保", "水土保持", "生態", "復育", "隔音牆", "柵欄", "防落石"], // 新增隔音牆等
            
            // === 原有施工管理（保留） ===
            "施工方法": ["施工方法", "工法", "施工程序", "工序", "瀝青", "施工流程"], // 新增變體
            "臨時工程": ["臨時", "支撐", "圍堰", "臨時橋", "便道", "洗車台", "施工架"], // 新增變體
            "品質管制": ["品管", "品質", "檢驗", "試驗", "品質管制"],
            
            // === 機電系統（原有1類→細分為5類） ===
            "電力系統": ["單線圖", "負載表", "壓降", "配電箱", "開關箱", "負載分析", "系統圖", "電力"], // 【新增】細分
            "弱電系統": ["弱電", "監視", "通訊", "廣播", "車輛管制", "CMS", "LCS", "架構圖", "車牌辨識"], // 【新增】細分
            "照明設備": ["照明", "路燈", "LED", "燈箱", "燈座", "行人燈"], // 【新增】細分
            "消防設備": ["消防", "警報", "消防栓", "消防設備", "昇位圖"], // 【新增】細分
            "機電設備": ["機電", "電氣", "控制器", "接線箱", "配件", "空調", "通風"], // 【保留】其他機電
            "排水機電": ["抽水", "泵浦", "機械", "電機"], // 【保留】原有
            
            // === 原有測量規劃（保留） ===
            "測量控制": ["導線網", "水準網", "控制點", "樁位", "測量", "控制網"],
            "都市計畫": ["都市計畫", "計畫圖", "用地", "路權圖", "路權"], // 新增路權相關
            "特殊材料": ["格柵鈑", "鍍鋅", "金屬", "吸隔音", "材料規格", "格柵", "蓋版", "蓋板", "鑄鐵蓋"], // 新增變體
            "錨固工程": ["錨筋", "灌漿", "地錨", "錨固"],
            
            // === 原有文件資料（保留+新增） ===
            "說明文件": ["說明", "圖例", "目錄", "封面", "圖目錄", "specification", "總說明", "索引", "對照表", "概要"], // 新增變體
            "工程數量": ["數量表", "工程數量", "材料表", "quantity", "統計表", "統計詳表", "數量統計"], // 新增變體
            "工程規範": ["規範", "標準", "準則", "規定", "注意事項"], // 新增變體
            "設置表": ["設置表", "配置表", "位置表", "一覽表", "設備表"], // 【新增】AI建議
            
            // === 基於文件資料新增的特殊類型 ===
            "網狀圖": ["網狀圖", "竣工網狀圖"], // 【新增】
            "高程資料": ["高程總表", "高程"], // 【新增】
            "災害修復": ["災害修復", "坍方清除", "修復工程", "修復"], // 【新增】
            "管線工程": ["管線", "管路", "預埋管", "管涵"], // 【新增】
            "土石處理": ["採取土石", "餘土堆置", "土方填築"], // 【新增】
            "機械設備": ["揚器", "傘型齒輪", "托架", "擴座"], // 【新增】
            "工程管理": ["工程告示牌", "勞工安全", "勞安", "安全衛生", "告示牌", "圍籬"] // 【新增】從原環境保護分離
        };
        
        let processedData = [];
        let originalData = [];
        
        // 自動分類函數
        function autoClassify(content) {
            const results = [];
            for (const [category, keywords] of Object.entries(classificationRules)) {
                if (keywords.some(keyword => content.includes(keyword))) {
                    results.push(category);
                }
            }
            return results.length > 0 ? results : ["未分類"];
        }
        
        // 記錄日誌
        function log(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        // 更新進度條
        function updateProgress(percent) {
            document.getElementById('progressFill').style.width = percent + '%';
        }
        
        // 處理文件上傳
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        });
        
        // 拖拽上傳
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                processFile(file);
            }
        });
        
        // 處理Excel檔案
        function processFile(file) {
            document.getElementById('progressBar').classList.remove('hidden');
            document.getElementById('logArea').classList.remove('hidden');
            
            log(`開始處理檔案: ${file.name}`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    log(`檔案讀取成功，工作表: ${workbook.SheetNames.join(', ')}`);
                    
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    log(`總共 ${jsonData.length} 行資料`);
                    updateProgress(20);
                    
                    // 提取C欄位資料並分類
                    originalData = [];
                    processedData = [];
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        if (jsonData[i] && jsonData[i][2]) {
                            const content = jsonData[i][2].toString().trim();
                            const categories = autoClassify(content);
                            
                            const rowData = {
                                row: i + 1,
                                originalContent: content,
                                categories: categories,
                                fullRow: jsonData[i]
                            };
                            
                            originalData.push(jsonData[i]);
                            processedData.push(rowData);
                        }
                        
                        if (i % 1000 === 0) {
                            updateProgress(20 + (i / jsonData.length) * 60);
                            log(`已處理 ${i} 筆資料...`);
                        }
                    }
                    
                    updateProgress(80);
                    log(`分類完成！共處理 ${processedData.length} 筆資料`);
                    
                    // 顯示結果
                    displayResults();
                    updateProgress(100);
                    log(`處理完成！`);
                    
                } catch (error) {
                    log(`錯誤: ${error.message}`);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // 顯示標籤頁
        function showTab(tabName) {
            // 隱藏所有標籤內容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有按鈕的active狀態
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 顯示選中的標籤
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
        }
        
        // 顯示分類結果
        function displayResults() {
            document.getElementById('results').classList.remove('hidden');
            
            // 統計分類結果
            const categoryStats = {};
            const unclassifiedItems = [];
            
            processedData.forEach(item => {
                item.categories.forEach(cat => {
                    categoryStats[cat] = (categoryStats[cat] || 0) + 1;
                });
                
                if (item.categories.includes('未分類')) {
                    unclassifiedItems.push(item);
                }
            });
            
            // 顯示總覽統計
            displayOverviewStats(categoryStats);
            
            // 顯示詳細分類
            displayCategoryDetails(categoryStats);
            
            // 顯示未分類項目
            displayUnclassifiedDetails(unclassifiedItems);
            
            // 顯示樣本資料
            displaySampleData();
            
            // 設定下載按鈕
            setupDownloadButtons();
        }
        
        // 顯示總覽統計
        function displayOverviewStats(categoryStats) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';
            
            // 總數據卡片
            statsGrid.innerHTML += `
                <div class="stat-card">
                    <span class="stat-number">${processedData.length}</span>
                    <span class="stat-label">總筆數</span>
                </div>
            `;
            
            // 分類數量卡片
            const totalCategories = Object.keys(categoryStats).length;
            statsGrid.innerHTML += `
                <div class="stat-card">
                    <span class="stat-number">${totalCategories}</span>
                    <span class="stat-label">分類種類</span>
                </div>
            `;
            
            // 未分類數量卡片
            const unclassifiedCount = categoryStats['未分類'] || 0;
            statsGrid.innerHTML += `
                <div class="stat-card">
                    <span class="stat-number">${unclassifiedCount}</span>
                    <span class="stat-label">未分類 (${((unclassifiedCount/processedData.length)*100).toFixed(1)}%)</span>
                </div>
            `;
            
            // 前5大分類
            const top5Categories = Object.entries(categoryStats)
                .filter(([cat]) => cat !== '未分類')
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
                
            top5Categories.forEach(([category, count]) => {
                const percentage = ((count / processedData.length) * 100).toFixed(1);
                statsGrid.innerHTML += `
                    <div class="stat-card">
                        <span class="stat-number">${count}</span>
                        <span class="stat-label">${category} (${percentage}%)</span>
                    </div>
                `;
            });
        }
        
        // 顯示詳細分類統計
        function displayCategoryDetails(categoryStats) {
            const categoryDetails = document.getElementById('categoryDetails');
            categoryDetails.innerHTML = '';
            
            // 按數量排序所有分類
            const sortedCategories = Object.entries(categoryStats)
                .sort(([,a], [,b]) => b - a);
            
            sortedCategories.forEach(([category, count]) => {
                const percentage = ((count / processedData.length) * 100).toFixed(1);
                
                // 獲取該分類的關鍵字
                const keywords = classificationRules[category] || ['系統自動分類'];
                
                categoryDetails.innerHTML += `
                    <div class="category-detail">
                        <div class="category-header">
                            <span class="category-name">${category}</span>
                            <span class="category-count">${count} 筆 (${percentage}%)</span>
                        </div>
                        <div class="category-keywords">
                            關鍵字: ${keywords.join(', ')}
                        </div>
                    </div>
                `;
            });
        }
        
        // 顯示未分類項目詳情
        function displayUnclassifiedDetails(unclassifiedItems) {
            const unclassifiedDetails = document.getElementById('unclassifiedDetails');
            
            if (unclassifiedItems.length === 0) {
                unclassifiedDetails.innerHTML = `
                    <div class="category-detail">
                        <h3 style="color: #27ae60;">🎉 太棒了！所有項目都已成功分類！</h3>
                        <p>沒有未分類的項目，分類系統運作完美！</p>
                    </div>
                `;
                return;
            }
            
            unclassifiedDetails.innerHTML = `
                <div class="category-detail">
                    <div class="category-header">
                        <span class="category-name">未分類項目</span>
                        <span class="category-count">${unclassifiedItems.length} 筆</span>
                    </div>
                    <p>以下項目未能自動分類，可能需要新增關鍵字或建立新的分類規則：</p>
                    <div class="unclassified-list">
                        ${unclassifiedItems.map((item, index) => 
                            `<div class="unclassified-item">${index + 1}. ${item.originalContent}</div>`
                        ).join('')}
                    </div>
                </div>
            `;
        }
        
        // 顯示樣本資料
        function displaySampleData() {
            const sampleTableBody = document.getElementById('sampleTableBody');
            sampleTableBody.innerHTML = '';
            
            // 顯示前50筆作為樣本
            processedData.slice(0, 50).forEach((item, index) => {
                const categoryTags = item.categories.map(cat => 
                    `<span class="category-tag">${cat}</span>`
                ).join('');
                
                sampleTableBody.innerHTML += `
                    <tr>
                        <td>${item.fullRow[1] || ''}</td>
                        <td>${item.originalContent}</td>
                        <td>${item.fullRow[3] || ''}</td>
                        <td>${categoryTags}</td>
                    </tr>
                `;
            });
        }
        
        // 設定下載功能
        function setupDownloadButtons() {
            document.getElementById('downloadBtn').onclick = function() {
                downloadExcel();
            };
            
            document.getElementById('downloadCsvBtn').onclick = function() {
                downloadCSV();
            };
        }
        
        // 下載Excel檔案
        function downloadExcel() {
            const wb = XLSX.utils.book_new();

            // === 第一個分頁：分類結果 (調整欄位寬度) ===
            const ws_data = [['工程名稱', '圖樣內容', '圖號', '分類結果']];
            processedData.forEach((item) => {
                ws_data.push([
                    item.fullRow[1] || '',
                    item.originalContent,
                    item.fullRow[3] || '',
                    item.categories.join(', ')
                ]);
            });
            const ws_main = XLSX.utils.aoa_to_sheet(ws_data);
            ws_main['!cols'] = [
                { wch: 25 * 3 }, // 工程名稱 (B欄位)
                { wch: 25 * 3 }, // 圖樣內容 (C欄位)
                { wch: 25 },     // 圖號 (D欄位)
                { wch: 25 * 2 }  // 分類結果 (E欄位)
            ];
            XLSX.utils.book_append_sheet(wb, ws_main, "分類結果");

            // === 第二個分頁：分類統計詳情 (調整欄位寬度) ===
            const categoryStats = {};
            processedData.forEach(item => {
                item.categories.forEach(cat => {
                    categoryStats[cat] = (categoryStats[cat] || 0) + 1;
                });
            });

            const stats_data = [['分類名稱', '數量', '百分比', '關鍵字列表']];
            Object.entries(categoryStats)
                .sort(([, a], [, b]) => b - a)
                .forEach(([category, count]) => {
                    const percentage = ((count / processedData.length) * 100).toFixed(1) + '%';
                    const keywords = classificationRules[category] ?
                        classificationRules[category].join(', ') : '系統自動分類';

                    stats_data.push([category, count, percentage, keywords]);
                });

            const ws_stats = XLSX.utils.aoa_to_sheet(stats_data);
            ws_stats['!cols'] = [
                { wch: 20 },
                { wch: 10 },
                { wch: 10 },
                { wch: 25 * 8 } // 關鍵字列表
            ];
            XLSX.utils.book_append_sheet(wb, ws_stats, "分類統計詳情");

            // === 第三個分頁：未分類項目 (移除欄位並調整寬度) ===
            const unclassified_data = [['工程名稱', '圖樣內容', '圖號']];
            processedData.forEach((item) => {
                if (item.categories.includes('未分類')) {
                    unclassified_data.push([
                        item.fullRow[1] || '',
                        item.originalContent,
                        item.fullRow[3] || ''
                    ]);
                }
            });

            const ws_unclassified = XLSX.utils.aoa_to_sheet(unclassified_data);
            ws_unclassified['!cols'] = [
                { wch: 25 * 3 }, // 工程名稱
                { wch: 25 * 3 }, // 圖樣內容
                { wch: 25 }      // 圖號
            ];
            XLSX.utils.book_append_sheet(wb, ws_unclassified, "未分類項目");

            // === 第四個分頁：分類規則參考 (調整寬度並移除欄位) ===
            const rules_data = [['分類名稱', '關鍵字']];
            Object.entries(classificationRules).forEach(([category, keywords]) => {
                rules_data.push([
                    category,
                    keywords.join(', ')
                ]);
            });

            const ws_rules = XLSX.utils.aoa_to_sheet(rules_data);
            ws_rules['!cols'] = [
                { wch: 25 * 2 }, // 分類名稱
                { wch: 25 * 5 }  // 關鍵字
            ];
            XLSX.utils.book_append_sheet(wb, ws_rules, "分類規則參考");

            XLSX.writeFile(wb, '工程圖樣分類結果_完整版.xlsx');
            log('Excel檔案下載完成！包含4個分頁：分類結果、統計詳情、未分類項目、分類規則');
        }

        // 下載CSV檔案
        function downloadCSV() {
            let csvContent = "工程名稱,圖樣內容,圖號,分類結果\n";

            processedData.forEach((item) => {
                const safeString = (value) => {
                    if (value === null || value === undefined) return '';
                    return String(value).replace(/"/g, '""');
                };

                const row = [
                    `"${safeString(item.fullRow[1])}"`,
                    `"${safeString(item.originalContent)}"`,
                    `"${safeString(item.fullRow[3])}"`,
                    `"${safeString(item.categories.join(', '))}"`
                ].join(',');
                csvContent += row + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "工程圖樣分類結果.csv";
            link.click();
            log('CSV檔案下載完成！');
        }
    </script>
</body>
</html>